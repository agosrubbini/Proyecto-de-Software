{% extends "layout.html" %}

{% block title %}Información y documentos del caballo{% endblock %}
{% block head %}
    {{ super() }}
    <link
          rel="stylesheet"
          href="{{ url_for('static', filename='styles/horsemen_and_amazons/jya_info.css') }}"/>
    <link
          rel="stylesheet"
          href="{{ url_for('static', filename='styles/horsemen_and_amazons/jya_list.css') }}"/>
{% endblock %}
{% block content %}

    <h1 class="titulo">Ficha del Caballo</h1>
    <div class="encabezado">
        <button id="info">Información General</button>
        <button id="docs">Documentos</button>
    </div>
    <hr class="separador">
    <div id="contenedor"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const horseData = {{ context.horse | tojson | safe }};
            const filesData = {{ context.files | tojson | safe }};
            const buttonInfo = document.getElementById('info');
            const buttonDocs = document.getElementById('docs');
            const contenedor = document.getElementById('contenedor');

            // Función para cargar la información del cabalo
            function cargarInformacion() {
                buttonInfo.classList.add('clicked');
                buttonDocs.classList.remove('clicked');
                contenedor.classList.remove('docs');

                let table_horses = `<table class="table is-striped">
                                    <thead>
                                        <tr>
                                            <th>Campo</th>
                                            <th>Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td>Nombre</td><td>${horseData.name}</td></tr>
                                        <tr><td>Fecha de nacimiento</td><td>${horseData.date_of_birth}</td></tr>
                                        <tr><td>Fecha de entrada</td><td>${horseData.date_of_entry}</td></tr>
                                        <tr><td>Genero</td><td>${horseData.gender}</td></tr>
                                        <tr><td>Raza</td><td>${horseData.race}</td></tr>
                                        <tr><td>Pelaje</td><td>${horseData.fur}</td></tr>
                                        <tr><td>Sede</td><td>${horseData.sede}</td></tr>
                                        <tr><td>tipo de jinetes y amazonas asignados</td><td>${horseData.type_jya_assigned}</td></tr>
                                    </tbody>
                                </table>`;

                contenedor.innerHTML = table_horses;
            }

            // Función para cargar los documentos
            function cargarDocumentos() {
                buttonDocs.classList.add('clicked');
                buttonInfo.classList.remove('clicked');
                contenedor.classList.add('docs');

                let inputs = `  
                    <form method="GET" action="{{url_for('horses.list_info_by_id', horse_id=context.id)}}">
                        <div class="field is-grouped">
                            <div class="field">
                                <label class="label">Nombre</label>
                                <div class="control has-icons-left">
                                    <span class="icon is-small is-left">
                                        <i class="fa-solid fa-magnifying-glass"></i>
                                    </span>
                                    <input class="input" type="text" name="title" placeholder="Nombre del documento" value="{{ search }}" />
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">Tipo</label>
                                <div class="control">
                                    <select name="document_type">
                                        <option>Selecciona un tipo</option>
                                        <option>Ficha general del caballo</option>
                                        <option>Planificacion de entrenamiento</option>
                                        <option>Informe de evolucion</option>
                                        <option>Carga de imagenes</option>
                                        <option>Registro veterinario</option>
                                    </select>
                                </div>
                            </div>
                            <button class="boton filter" type="submit">Filtrar</button>
                        </div>
                    </form>
                    <form method="GET" action="{{ url_for('horses.list_info_by_id', horse_id=context.id) }}">
                        <input type="hidden" name="page" value="{{ page }}">
                        <div class="control order_options_docs">
                            <select id="order_option" name="order_option" onchange="this.form.submit()">
                                <option value="default">Selecciona un orden</option>
                                <option value="title_asc">Nombre: A-Z</option>
                                <option value="title_desc">Nombre: Z-A</option>
                                <option value="date_asc">Fecha: Menor-Mayor</option>
                                <option value="date_desc">Fecha: Mayor-Menor</option>
                            </select>
                        </div>
                    </form>
                `;

                contenedor.innerHTML = inputs;

                if (filesData.length > 0) {
                    let table_docs = `
                        <table class="table is-striped">
                            <thead>
                                <tr>
                                    <th>Titulo</th>
                                    <th>Fecha de subida</th>
                                    <th>Tipo</th>
                                    <th>Operaciones</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    filesData.forEach(f => {
                        table_docs += `
                            <tr>
                                <td>${f.title}</td>
                                <td>${f.upload_date}</td>
                                <td>${f.document_type}</td>
                                <td>
                                    <select class="operations" data-file-id="${f.id}" data-file-type="${f.file_type}">
                                        <option value="default">Selecciona la operación</option>
                                        <option value="edit">Editar</option>
                                        <option value="delete">Eliminar</option>
                                        <option value="${f.file_type === 'Link' ? 'open' : 'download'}">
                                            ${f.file_type === 'Link' ? 'Ir al documento' : 'Descargar'}
                                        </option>
                                    </select>
                                </td>
                            </tr>
                        `;
                    });
                    table_docs += `
                            </tbody>
                        </table>
                        <nav class="pagination" role="navigation" aria-label="pagination">
                            <a class="boton pagination-previous" {% if not context.pagination.has_prev %}disabled{% else %} href="{{url_for('horses.list_info_by_id', horse_id=context.id, page=page-1,  order_option=order_by, title=title, document_type=document_type)}}"{% endif %}>Anterior</a>
                            <a class="boton pagination-next" {% if not context.pagination.has_next %}disabled{% else %} href="{{url_for('horses.list_info_by_id', horse_id=context.id, page=page+1,  order_option=order_by, title=title, document_type=document_type)}}"{% endif %}>Siguiente</a>
                        </nav>

                    `;


                    contenedor.innerHTML += table_docs;
        
                }
                else{
                    contenedor.innerHTML += `<p style="text-align: center">No hay archivos asociados al caballo</p>`;
                }

                let boton = ` <a href="{{ url_for('horses.add_file', horse_id=context.id) }}"><button class="boton add-file">Añadir archivo</button></a>`;

                contenedor.innerHTML += boton;
            }

            // Recuperar el estado del Local Storage
            const selectedTab = localStorage.getItem('selectedTab');

            if (selectedTab === 'docs') {
                cargarDocumentos(); // Cargar la pestaña de documentos
            } else {
                cargarInformacion(); // Cargar la pestaña de información por defecto
            }

            // Evento del botón de Información General
            buttonInfo.addEventListener('click', () => {
                cargarInformacion();
                localStorage.setItem('selectedTab', 'info'); // Guardar el estado
            });

            // Evento del botón de Documentos
            buttonDocs.addEventListener('click', () => {
                cargarDocumentos();
                localStorage.setItem('selectedTab', 'docs'); // Guardar el estado
            });

            // Manejo de cambios en las operaciones
            document.addEventListener('change', (e) => {
                if (e.target.classList.contains('operations')) {
                    const selectedValue = e.target.value;
                    
                    const fileType = e.target.dataset.fileType;
                    const fileId = e.target.dataset.fileId;

                    console.log(fileId);
                    
                    if (selectedValue === 'delete'){
                        const deleteUrl = "{{ url_for('horses.delete_file', horse_id=context.id, file_id=0) }}".replace('/0', `/${fileId}`);
                        window.location.href = deleteUrl;
                    }

                    // Si la opción seleccionada es "Ir al documento"
                    if (selectedValue === 'open' && fileType === 'Link') {
                        const selectedFile = files.find(file => file.id === parseInt(fileId));
                        window.open(selectedFile.file_url, '_blank'); // Abre el enlace en una nueva pestaña
                    }

                    if (selectedValue === 'download' && fileType !== 'Link') {
                        const downloadUrl = "{{ url_for('horses.download_file', horse_id=context.id, file_id=0) }}".replace('/0', `/${fileId}`);
                        window.location.href = downloadUrl;
                    }

                    if (selectedValue === 'edit'){
                        const editUrl = "{{ url_for('horses.edit_file', horse_id=context.id, file_id=0) }}".replace('/0', `/${fileId}`);
                        window.location.href = editUrl;
                    }
                }
            });
        });
    </script>
{% endblock %}
